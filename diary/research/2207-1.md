## 22/07/03, Sun

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-03_09.00.49.jpg" width="240px">

おととい届いて動作確認できてなかった[名刺型基板MeishinoCH552](https://github.com/akita11/MeishinoCH552)、R1とR2の値を間違って指定していた（正しくは5.1kのところを1kを指定していた）。手動で載せ替えて動作OK。BOMをふくめてGitHubを更新。これで[今日の基板設計体験イベント](https://makepcba.peatix.com/)にまにあった。スライドは[これ](https://www.slideshare.net/junichiakita9/ss-252110097)。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-03_09.17.24.jpg" width="240px">

今日の気付き。Groveコネクタは、K型コテ先で一発ではずせる。めちゃ便利。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-03_10.06.30.jpg" width="240px">

このまえコレクションしてたTaoBaoで売ってるSTM32互換チップ、一番謎だった”メーカー名なし"（刻印はSTM32）の2つ、中のチップが違ってた（左の2つ）。右端のはSZLCSCで買ったSTM32F030だから本物（のはず）で、チップサイズを見る限り”無印”も本物と同じっぽい。顕微鏡で詳しく見てみよう。この無印チップ、もうあと何個か買って比べてみるか。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-03_12.10.42.png" width="240px">

と、改めてそのチップを買ったTaoBaoのショップを見てみたら、選択肢に「新品」と「テストOK品」というのがあって、後者のほうが1元安い。香ばしすぎる。とりあえず5個買った。中身は何種類あるんだろう。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-03_09.18.02.jpg" width="240px">

M5Stack新製品の案をもう1つ。NT金沢をいっしょにやってる電飾職人(?)の[五味さん](https://twitter.com/GomiHgy)から、NeoPixelをたくさん使うと電源容量がたりないので、外から給電だけするGrove中継機がほしいなだよね、という話を聞いて、たしかに、と思って。ほかにも振動モータとかは本体からだと電源容量が足りないことがたまにあるので、そいうのにも使える。いろいろ探した結果、既存の製品のうち"1-to-3 Hub UNIT"のケースを流用するのが良さそう、との結論にたっした。これの手前のところに、GroveコネクタではなくてUSB Type-Cコネクタを置き、そこから下流へ給電する。制御信号だけ、上流から下流へ。下流が2個になるから分岐もできる。
早速Jimmyを交えたWeChatグループチャットで相談。USB Type-Cよりも、VH3.96とか2.1mmDCとかのほうが使いやすいんじゃ？ということを言われたんだけど、電飾だとモバイルバッテリが使えるのがとても便利で、かつDC2.1mmだと間違えて12Vとかの高い電圧を加えて壊しかねないので（DC/DCを入れるという方法もあると言われたけど）、Type-Cが以下にMakerにとって使いやすいか、ということを説明して、納得してもらえた。というわけで"1-to-3 Hub UNIT"の基板データをもらって設計をはじめる。


## 22/07/04, Mon

広州の東の方で、自動運転のタクシー・バスが乗れるというので、いってきた。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-04_13.55.40.jpg" width="240px">

アプリをいれると、地図で「乗る場所」と「降りる場所」を選択肢から選んで、「呼ぶ」ボタン。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-04_13.56.15.jpg" width="240px">

すると近くにいる自動運転タクシーがこっちへ発車。[しばらくすると自動運転タクシーがやってくる](https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-04_13.32.22.mp4)。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-04_13.51.58.jpg" width="240px">

車の屋根にはこんな感じでLiDARやカメラがついているけど、そんなに数は多くない。

[走り始めるとこんなかんじ](https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-04_13.30.19.mp4)。運転手さんは乗っているけど手はハンドルから離している。座席前のモニタに、周りの認識状況が表示されていて、クルマは直方体のオブジェクトとして、それ以外の歩行者や自転車、木などは点群のまま。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-04_14.03.36.jpg" width="240px">

途中は、それなりに交通量もあって、中国特有の電動バイクがチョロチョロ走っている、まあ自動運転にとってはやりにくい環境なんだけど、そんなに危なっかしく感じることもなく、60km/hくらいで走っている。すごいな。途中、右車線の車が割り込みかけてきたという場面もあったんだけど、少し左によけつつ、少し加速して前に出る、というのも自動でやっていた。

料金は普通のタクシーぐらいだった。現状だと乗っているだけの運転手さんの人件費がかかるし、地図データ作成などにそれなりにお金も手間もかかるから、ビジネスとしてどうなるのかはよくわからないけど、未来を感じる。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-04_14.11.43.jpg" width="240px">

ついたら、アプリで支払い。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-04_15.05.42.jpg" width="240px">

同じく、少し離れた地区で走っている自動運転バスも乗ってみた。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-04_15.06.31.jpg" width="240px">

こちらはテスト中ということで無料。こちらは人も少なめの地区で、定まったルートを走ることもあって、危なっかしさを感じることもなかった。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-04_15.07.51.jpg" width="240px">

前後の四隅にカメラとLiDARがついている。前方は斜め下向きのLiDARもついていた。

今日、JETROの方、高須さんとお話をしていて気づいたんだけど、ESP8266/ESP32をつくっているEspressifは、ムーアの法則をうまく使った例、と言えることに気づいた。つまり微細化による性能向上とは別の、やや古めのテクノロジを使ってコストを抑えつつ、「無線機能がメインで、演算性能はそんなにたいしたことないマイコン、だけどとても低価格」というジャンルを開拓して確立した製品、といえる。NeoPixelと同じ並びで語れる例とえいる。


## 22/07/05, Tue

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-05_09.48.00.jpg" width="240px">

この前買った細長いUSB顕微鏡を、持ってきた太いUSB顕微鏡の台に固定するアタッチメントをJLCPCBの3Dプリントに出してたの、届いた。ぴったり。ネジでしめればしっかり固定できる。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022_07_05_10.02.00.png" width="240px">

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022_07_05_10.02.05.png" width="240px">

STCmicroのSTC8G純正書き込みツールのSTC-ISP、タイマの設定やループまわすdelayのコードの生成ツールがある。めちゃ便利。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022_07_05_10.10.00.png" width="240px">

ついでにSTC-ISPの設定をみてたら、起動時のリセットを長めに待つ、というオプションがあって、デフォルトでONになっている。データシートを読み返したけど、少なくとも英語版にはこれのことは書いてないっぽいが、実測で100msくらいリセット待ちするようだ。

このまえの「ルネサスがArduinoに出資、というニュースについて、[特電のなひたふさんがblogを書いている](http://nahitafu.cocolog-nifty.com/nahitafu/2022/06/post-051268.html)。いろいろありすぎる。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-05_14.12.40.png" width="240px">

日曜日にやった基板設計イベントに向けて設計したMeishinoCH552で、JLCPCBのWebからPCBAの発注をすると、CH552とUSBコネクタだけ、向きがズレる、という現象がある。この図はWebビューアでみたUSBコネクタの配置。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-05_14.13.17.png" width="240px">

ただ、この部品の情報Footprintからみえる、EasyEDA用のライブラリだと、こんなふうに出る。一般的にはこの向きを「0度」と定義するはず。そしてCPLファイルでの部品の向きは「180度」。実際の基板上でも、コネクタはこのFootprint図の180度回転した向きなので、CPLファイルでの指定は正しい。しかしWebビューアだと、どうみても90度or270度ズレてる。もしかしてWebビューアのバグなんだろうか。とはいえ抵抗とかチップLEDなどの向きはこんなふうに90度ズレる、というのはおこらない。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-05_16.03.05.png" width="240px">

M5Stack新製品案の追加、NeoPixelをたくさん使う電飾勢は電流不足しがち問題、USB-Cから5Vを下流側に供給するための中継機。ケースは1-to-3 Hub UNITをを流用。設計おわったので基板つくってもらう。データを渡して1.5時間後くらいに、GNDパターンを少し太くしたほうがいいな、と改良をしたら、もう発注済みとのこと。相変わらず早いな。

このまえから試しているpicoprobe、RaspberryPiPicoが届いたので書き込みテスト。ArduinoIDE(Win)からpicoprobe経由で、RasPicoに書き込みはできるようになった。でも自作ボードで同じ配線をしても書き込みができない。エラーメッセージをみると"DAP init failed"とでてる。RP2040でDAPを初期化できないって、なんでじゃ？水晶いるんだっけ？

夜は、3月の高須さんの講義で呼んでいただいている、早稲田ビジネススクールの牧先生の授業受講生・ゼミ生のみなさんとオンラインで、深センの生活について紹介したりしてた。自分がM5Stackでやってることは、見方を変えると、深センの企業に社員じゃない人が入ってゼロから製品をリリースまで2ヶ月で持っていく、それはなぜできるのか、という点から考えることができるのか、と、勉強になった。


## 22/07/06, Wed


## 22/07/06, Wed

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-06_10.59.34.png" width="240px">

JLCPCBのPCBAの配置ビューア、ちょっと謎な挙動がある。手元(KiCAD)と向こうで0度の定義が違う場合はあるので、それは理解できる（この例だと一番下）んだけど、両者が一致しているのに、CPLで指定してる向きとビューアでの向きが90度ずれてるのがある。バグなんかな。

[「次世代X-nics 半導体創生拠点形成事業 Agile-X 革新的半導体の民主化拠点 キックオフシンポジウム」](https://nanonet.mext.go.jp/sp/page/page000105.html)というのを聴講していた。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-06_14.28.45.png" width="240px">

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-06_14.30.05.png" width="240px">

招待講演は、GoogleでMPWの中の人の一人、Johan Euphrosine氏。背景と問題意識のところのスライドは、まさに自分がMakeLSI:を始めることにした問題意識で、つまり普遍的な問題点ともいえる。
やはりすごいというかうまいな、と思うのは、他の巻き込み方。企業、アカデミアを、本当にうまくまきこみながら、どんどん進めている。
内容も、HDLからのデジタルから始まって、他ノードへも移行できるアナログ、Linuxが動くCPUなど、参加者がフレームワークや実例をつくる（そしてもちろん共有される）サイクルがまわっていて、まさしく「民主化」という言葉の意味を正しく確実に実現しようとしている。「民主化」なんて、上から目線でできるはずがない。ちゃんと同じ目線まで降りて、いっしょに汗を流している。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-06_14.22.42.png" width="240px">

ところでこのEuphrosine氏に、だいぶ前からTwitterをフォローされていることに気づいて、ちょっとビビった。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-06_15.59.16.png" width="240px">

その中でのユーザ側の話として、川原先生のお話。まさにこれ。「半導体を道具に」

あとしばらく難儀しているSTM32Fの割り込みでのI2Cスレーブ、ちょっとブレイクスルーがあった。[ちょうと似たことをやっている事例](http://meerstern.seesaa.net/article/476512939.html)を見つけた。1段階ずつ動作を追っていくと、どうもTRANSFER_DIR_WRITE/READが逆っぽくて、それをなおしたらだいぶ動作が進んだ。ただ、よくあるマスタからREGアドレス書き込み→続けてデータを読み出し、という動作だと、書き込み時にすぐにデータを返す、ようになってしまうようで、I2Cアドレスマッチ時の動作が読み出しだったらデータを返す、というようにしたら、それらしく動作するようになった。ただ、書き込みを連続して行う場合の扱いが、これだとできない（受信を1バイトに決め打ちしているため）。うーむ。積みかけている予感。要は、ExtIo2のソースをベースに改造をしたい（けど使っているペリフェラルが違うので再構成をしたいがKeilとSTM32CubeMXのバージョンが違うので、手元でできない）、ということなので、M5StackのほうでSTM32FのFWを書いているJay氏に、ヘルプを求めよう・・・つまり、既にI2C受信ができているExtIo2と同じようなスケルトンを、こっちのボードのペリフェラルの構成ファイルを渡して、そっちのKeil/STM32CubeMXで作ってくれないか、という相談。Jay氏の手をわずらわせるのは申し訳ないけど、ヘルプを求めてみることにする。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-06_18.52.52.png" width="240px">

とお願いしたら20分後に「ほれ」と送られてきた（しかも実機動作確認済み）。ひょえ・・・簡単な動作（FWバージョン読み出し）を実装してみたら、ばっちり動く。今日まる一日、格闘していたのはなんだったんだろう・・・やはり生き字引は頼るべきだな。

<img src="https://github.com/akita11/SZdiary/blob/main/diary/photo/2022-07-06_20.43.29.jpg" width="240px">

TaoBaoで頼んでいた、「無印STM32F030（テストOK品）」をもう5個買っていたのが届いた。マークは、まあ本物っぽいだけど、足にハンダが少し残っているから、少なくとも再利用品。で、マークの真偽のほどは、中を見るしかない。


***

[前の週へ](2206-4.md) /
[次の週へ](2207-2.md)

今週の
[日常](../diary/2207-1.md) /
[研究](../research/2207-1.md) /
[コロナ関連](../covid19/2207-1.md) / 
[中国語勉強](../chinese/2207-1.md) / 

[SZdiaryトップ](../../README.md)
